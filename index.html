<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubble Chart with Force Layout</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <label for="stayDropdown">Choose Patient's Stay:</label>
    <select id="stayDropdown">
        <option value="">Select Stay ID</option>
    </select>

    <svg width="1300" height="800"></svg>
    <div id="tooltip" style="position: absolute; opacity: 0; background-color: white; padding: 5px; border: 1px solid black;"></div>

    <script>
        const width = 1300;
        const height = 800;
        const margin = { top: 20, right: 20, bottom: 50, left: 70 };

        const xScale = d3.scalePoint().range([margin.left, width - margin.right]);
        const yScale = d3.scaleLinear().range([height - margin.bottom, margin.top]);
        const sizeScale = d3.scaleSqrt().range([3, 30]); // Reduce max radius
        const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

        const svg = d3.select("svg");
        const tooltip = d3.select("#tooltip");

        // Load data
        console.log("Loading data...");
        Promise.all([
            d3.csv('/Dataset/icu/inputevents.csv'),
            d3.csv('/Dataset/icu/d_items.csv')
        ]).then(([inputEvents, dItems]) => {
            console.log("Data loaded successfully.");
            console.log("Input Events:", inputEvents);
            console.log("D_Items:", dItems);

            const dItemsMap = new Map();
            dItems.forEach(d => {
                if (d.itemid) {
                    dItemsMap.set(d.itemid, d.label || "Unknown");
                }
            });
            console.log("D_Items Map:", dItemsMap);

            const uniqueStayIds = [...new Set(inputEvents.map(d => d.stay_id))];
            const dropdown = d3.select("#stayDropdown");
            uniqueStayIds.forEach(stay_id => {
                dropdown.append("option").attr("value", stay_id).text(stay_id);
            });
            console.log("Unique Stay IDs added to dropdown:", uniqueStayIds);

            function updateChart(stayId) {
                console.log("Updating chart for Stay ID:", stayId);

                const filteredData = inputEvents.filter(d => d.stay_id === stayId);
                console.log("Filtered Data:", filteredData);

                const aggregatedData = d3.rollups(filteredData, v => {
                    const firstEvent = v[0];
                    return {
                        frequency: v.length,
                        order_category_name: firstEvent.ordercategoryname,
                    };
                }, d => d.itemid).map(([item_id, d]) => {
                    const abbreviation = dItemsMap.get(String(item_id)) || "Unknown";
                    return {
                        item_id,
                        abbreviation,
                        order_category_name: d.order_category_name,
                        frequency: d.frequency
                    };
                });
                console.log("Aggregated Data:", aggregatedData);

                const maxBubbleCount = 20;
                const bubbleCount = aggregatedData.length;
                console.log("Bubble Count:", bubbleCount);

                if (bubbleCount > maxBubbleCount) {
                    sizeScale.range([2, 15]);
                } else if (bubbleCount < 10) {
                    sizeScale.range([5, 50]);
                } else {
                    sizeScale.range([3, 30]);
                }

                xScale.domain([...new Set(aggregatedData.map(d => d.order_category_name))]);
                yScale.domain([0, d3.max(aggregatedData, d => d.frequency)]);
                console.log("X Scale Domain:", xScale.domain());
                console.log("Y Scale Domain:", yScale.domain());

                svg.selectAll("circle").remove();
                svg.selectAll("text.abbreviation").remove();

                const simulation = d3.forceSimulation(aggregatedData)
                    .force("x", d3.forceX(d => xScale(d.order_category_name) + xScale.bandwidth() / 2).strength(1.5))
                    .force("y", d3.forceY(d => yScale(d.frequency)).strength(1.5))
                    .force("collide", d3.forceCollide(d => sizeScale(d.frequency) + (bubbleCount > maxBubbleCount ? 0.7 : 1)))
                    .stop();

                for (let i = 0; i < 500; i++) simulation.tick();
                console.log("Simulation complete. Node positions updated.");

                svg.selectAll("circle")
                    .data(aggregatedData)
                    .enter()
                    .append("circle")
                    .attr("cx", d => d.x+10)
                    .attr("cy", d => d.y+10)
                    .attr("r", d => sizeScale(d.frequency))
                    .attr("fill", d => colorScale(d.order_category_name))
                    .attr("opacity", 0.8)
                    .on('mouseover', (event, d) => {
                        tooltip.transition().duration(200).style('opacity', 1);
                        tooltip.html(`Category: ${d.order_category_name}<br>Frequency: ${d.frequency}`)
                            .style('left', (event.pageX + 15) + "px")
                            .style('top', (event.pageY - 30) + "px");
                    })
                    .on('mouseout', () => {
                        tooltip.transition().duration(500).style('opacity', 0);
                    });
                console.log("Circles drawn.");

                svg.selectAll('text.abbreviation')
                    .data(aggregatedData)
                    .enter()
                    .append('text')
                    .attr('class', 'abbreviation')
                    .attr('x', d => d.x)
                    .attr('y', d => d.y)
                    .attr('text-anchor', 'middle')
                    .attr('dy', '.35em')
                    .text(d => d.abbreviation)
                    .style('fill', 'white')
                    .style('font-size', bubbleCount > maxBubbleCount ? '6px' : '8px');
                console.log("Abbreviations drawn.");
            }

            dropdown.on("change", function() {
                const selectedStayId = this.value;
                console.log("Dropdown changed, selected Stay ID:", selectedStayId);
                if (selectedStayId) {
                    updateChart(selectedStayId);
                } else {
                    svg.selectAll("circle").remove();
                    console.log("Cleared chart.");
                }
            });

            svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .append("text")
                .attr("x", width / 2)
                .attr("y", margin.bottom - 10)
                .attr("fill", "black")
                .style("font-weight", "bold")
                .style("text-anchor", "middle")
                .text("Order Category Name");
            console.log("X-axis label added.");
        }).catch(error => {
            console.error("Error loading data:", error);
        });

    </script>
</body>
</html>
